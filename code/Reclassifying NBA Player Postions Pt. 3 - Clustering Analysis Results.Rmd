---
title: "Reclassifying NBA Player Postions Pt. 3 - Clustering Analysis Results"
author: "Mike Kaminski"
date: "2023-06-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE,
                      message = FALSE, dpi = 180,
                      fig.width = 10, fig.height = 5)

knitr::opts_knit$set(root.dir = "C:/Users/mikek/Documents/NBA-Player-Clustering")
```

# Libraries
```{r libraries}
library(tidymodels) # broom, dials, parsnip, tune, workflows, yardstick
library(tidyverse) #ggplot2, dplyr, tidyr, readr, purr, tibble, stringr, lubridate
library(gghighlight)

```

# Read in the Data
```{r Read_Data}
NBACleanData <- read_csv("Data/model0623.csv",show_col_types = FALSE) %>% select(-1)
model_df <-  NBACleanData %>% select(-80) %>%
  mutate(Year = as.character(Year)) %>%
  mutate(across(where(is.numeric), ~as.numeric(scale(.))))
```

From Pt.2 of the project, I decided to use 7 clusters.  Using PCA didn't really provide improved results in the dataset, plus I need to be able to explain the results in a concise format.  Therefore, I've opted to not use PCA to reduce dimensionality.  I've also decided to use kmeans over hierarchical, as I think it will be a little bit easier to interpret.

# Modeling
From the last part, here is the model
```{r Model}
set.seed(1234)

nba_clust <- kmeans(model_df %>% select(-c(1:4)),
                    iter.max = 500 , 
                    nstart = 100 ,
                    centers = 7)
```

```{r Augment}
head(augment(nba_clust, model_df)[, c(80,1:9)],5) 

nba_aug <- augment(nba_clust, model_df) %>% 
  rename(Cluster = .cluster) %>%
  select(-c(1:4)) %>%
  select(Cluster, everything()) 

test <- nba_aug %>%
  pivot_longer(!Cluster, names_to = 'feature', values_to = 'value')
```

# Create a Dataframe for Plotting Results
```{r dataframe}
options(scipen = 99)
kmeans_centers <- data.frame(Cluster = c(paste0('Cluster ', 1:7)), nba_clust$centers) %>% #creates a column w/ the cluster name
  pivot_longer(!Cluster, names_to = 'feature', values_to = 'center') %>% #pivots longer for easier graphing
  mutate(feature = as.factor(feature)) %>% #makes the feature a factor
  mutate(Cluster = as.factor(Cluster))
head(kmeans_centers)
```

The plots below showcase the makeup of each cluster. 

* Plot 1: Each stat category is listed on the x-axis and the cluster center is listed on the y-axis. The labels on each point represent the rank of that cluster within each stat category.  <br>
  + A rank of 1 in the per game pre 100 possessions, and advanced stat categories (suffixed with pp, pg, adv), indicate that players in that cluster performed particularly well in that category - with the exception being in the personal foul and turnover stat categories (PF and TOV), where a high value is less desirable
  + A rank of 1 in the shooting stat category is more informational rather than desirable or undesirable.  It represents, among other stats, the distances where players are taking shots from.  For example, it helps identify which players/clusters take 3-point shots vs shots close to the basket.
  + Looking at Cluster 1, we see that players in this cluster get a lot of rebounds (Reb_T, Reb_D, Reb_O) - they have a high cluster center and rank first within that category.  We also see that they commit a lot of fouls and have a poor defensive rating.  A high cluster center for fouls is undesirable and a low cluster center for defensive rating means that these players aren't good at defense (more offensive minded).

* Plot 2: This shows the percentage of stats that fall within each rank for the cluster
  + If there's a high percentage in ranks 1 and 2, it means that the cluster includes players that generally perform well.  If there's a high percentage in ranks 6 and 7, that means that the cluster includes players that generally don't contribute as much as the others

* Plot 3:  This shows the count of traditional NBA positions in each cluster.

I've included a new position name for each cluster, a summary of each position (aka cluster), and listed some of the players from the 2022 season that fall into each position.

# Function for plotting all the clusters
```{r}
cluster_plots <- function(cluster_value) {
  
  # Geom_point for rankings in each category
  filtered_data <- kmeans_centers %>%
    group_by(feature) %>%
    mutate(rank = ifelse(as.character(feature) %in% c('PF_pg', 'PF_pp', 'TOV_pg', 'TOV_pp', 'TOV_pct_adv'), 
                         rank(center), 
                         rank(desc(center)))
    )%>% # adjust rank for high values in less desriable stat categories
    arrange(case_when(Cluster == cluster_value ~ 1, TRUE ~ 2), Cluster, rank, desc(center)) %>%
    mutate(Cluster = as.character(Cluster)) %>%
    filter(Cluster == cluster_value)
  
  plot <- kmeans_centers %>%
    group_by(feature) %>%
    mutate(rank = ifelse(as.character(feature) %in% c('PF_pg', 'PF_pp', 'TOV_pg', 'TOV_pp', 'TOV_pct_adv'), 
                         rank(center), 
                         rank(desc(center)))
    )%>% # adjust rank for high values in less desriable stat categories
    arrange(case_when(Cluster == cluster_value ~ 1, TRUE ~ 2), Cluster, rank, desc(center)) %>%
    ggplot(aes(x = factor(feature, levels = unique(feature)), y = center, color = cluster_value)) +
    geom_point(color = "#5A2D81") +
    geom_text(data = filtered_data, aes(label = rank), color = "black", vjust = -0.5) +  # Add point labels for rank
    theme_minimal() +
    gghighlight(Cluster == cluster_value, use_direct_label = FALSE) +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 90, size = 9, hjust = 0.5),
          axis.title = element_text(hjust = 0.5),
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
    labs(x = "Statistic", y = "Cluster Center",
         title = "Visualizing K-Means Cluster Makeups",
         subtitle = cluster_value)
  
  print(plot)
  
  
  # Bar Plot for Percentage of Stat Categories in Each Rank
  filtered_data <- kmeans_centers %>%
    group_by(feature) %>%
    mutate(rank = ifelse(as.character(feature) %in% c('PF_pg', 'PF_pp', 'TOV_pg', 'TOV_pp', 'TOV_pct_adv'), 
                         rank(center), 
                         rank(desc(center)))
    ) %>%
    arrange(case_when(Cluster == cluster_value ~ 1, TRUE ~ 2), Cluster, rank, desc(center)) %>%
    mutate(Cluster = as.character(Cluster)) %>%
    filter(Cluster == cluster_value)
  
  plot <- kmeans_centers %>%
    group_by(feature) %>%
    mutate(rank = ifelse(as.character(feature) %in% c('PF_pg', 'PF_pp', 'TOV_pg', 'TOV_pp', 'TOV_pct_adv'), 
                         rank(center), 
                         rank(desc(center)))
    ) %>%
    ungroup() %>%
    select(Cluster, rank) %>%
    group_by(Cluster, rank) %>%
    summarise(count = n()) %>%
    ungroup() %>%
    group_by(Cluster) %>%
    mutate(percentage = count / sum(count) * 100) %>%
    filter(Cluster == cluster_value) %>%
    ggplot(aes(x = as.factor(rank), y = percentage, fill = as.factor(rank))) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = paste0(round(percentage, 0), "%")), vjust = -0.5, color = "black") +
    labs(x = "Rank", y = "Percentage",
         title = "Percentage of Stat Categories in Each Rank", subtitle = cluster_value) +
    scale_fill_discrete(name = "Rank") +
    scale_x_discrete(limits = as.character(1:7)) +
    theme_minimal()
  
  print(plot)
  
  #Bar plot that shows count of traditional positions in each cluster
  df_2022 <- final_df %>%
    filter(Year %in% '2022')
  
  count_df <- df_2022 %>%
    filter(Cluster == substr(cluster_value, nchar(cluster_value), nchar(cluster_value))) %>%
    group_by(Pos) %>%
    summarise(count = n()) %>%
    ungroup() %>%
    arrange(desc(count))
  
  plot <- ggplot(count_df, aes(x = reorder(Pos, -count), y = count, fill = Pos)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = count), vjust = -0.5, color = "black") +
    scale_fill_manual(values = c("red", "blue", "green", "yellow", "orange")) +
    labs(x = "Pos", y = "Count", title = paste0("Bar Plot of Traditional Positions in ", cluster_value))
  
  print(plot)
}
```

## Cluster 1
```{r}
cluster_plots('Cluster 1')
```

## Cluster 2
```{r}
cluster_plots('Cluster 2')
```

## Cluster 3
```{r}
cluster_plots('Cluster 3')
```

## Cluster 4
```{r}
cluster_plots('Cluster 4')
```

## Cluster 5
```{r}
cluster_plots('Cluster 5')
```

## Cluster 6
```{r}
cluster_plots('Cluster 6')
```

## Cluster 7
```{r}
cluster_plots('Cluster 7')
```

```{r}

df_2022 %>%
  filter(Cluster == 7) %>%
  select(1:10)

df_2022 %>%
  group_by(Cluster) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)

```


# Analysis of 2022 Players
## Historical and Current Cluster Analysis
The below plot shows how the player types have evolved since the 2000-2001 season and a brief summary of each cluster is included.

* Rebound Kings have generally decreased over the years, peaking around 12% in 2003, 2009, and 2010, but currently only make up 5% of players in the league..
* 3-point Threats have increased significantly over the years, making up 42% of players in the league.  The percentage has almost quadrupled from 11% in 2001.
* Game Lieutenants have remained somewhat consistent, generally between 15%-25%.
* Bigmen Shooters have decreased from 27% in 2001 to only 6.2% in 2022.  It's likely that some of these players have become 3-point Threats
* Bench Support has remained relatively constant, which makes sense since bench players are always needed
* Primetime Bigs have remained relatively constant, fluctuateing between 7% and 12%
* Superstars have also remained constant, but low, generally between 4% and 9%.  These players are valuable and hard to come by

```{r fig.width = 16, fig.height = 10}
ggplot(final_df %>% mutate(Year = as.numeric(Year)),
       aes(x=Year, 
           fill=factor(Cluster))
       ) +
  geom_bar(position="fill") +
  geom_text(
    aes(label=paste0(signif(..count.. / tapply(..count.., ..x.., sum)[as.character(..x..)]*100, digits=2),"%")), 
    stat="count",
    position=position_fill(vjust=0.5),colour="black", size=3)+
  labs(y="Percentage") +
  scale_x_continuous("Year", breaks=seq(2001,2022,by=1)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_fill_discrete(name = "Player\nType", labels =c('Rebound\nKings', '3-point\nThreats', 'Game\nLieutenants', 'Bigmen\nShooters','Bench\nSupport', 'Primetime\nBigs', 'Superstars')) +
  theme(legend.key.height=unit(1, "cm"))
```

The plot below displays the count of each traditional player position (C, PF, SF, SG, PG) within each of the new clusters (i.e. new player types).

1. Rebound Kings
2. 3-point Threats
3. Game Lieutenants
4. Bigmen Shooters
5. Bench Support
6. Primetime Bigs
7. Superstars

* Of the seven new player types, 3-point Threats and Superstars include players from all 5 traditional positions.
* Bench Support and Game Lieutenants include players from all 5 as well, but only have 1 player in some of the positions
* Rebound Kings and Primetime Bigs are primarily traditional Centers and Power Forwards

```{r}
ggplot(final_df %>% 
         mutate(Year = as.numeric(Year),
                Cluster = as.numeric(Cluster)) %>%
         filter(Year == 2022),
       aes(y = Cluster, fill = Pos)) +
  geom_bar(aes(x = (..count..)),colour="white") +
  geom_text(stat='count', aes(label=..count..),position = position_stack(vjust = 0.5), color = "black") +
  ggtitle("Count of Traditional Position in Each New Player Type - 2022") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(name="Cluster", breaks = c(1,2,3,4,5,6,7)) +
  labs(fill = "Traditional\nPosition", x = "Count") +
  theme(legend.key.height=unit(2, "cm"))
```

# Function for plotting all the clusters
```{r}
cluster_plots <- function(cluster_value) {
  
  # Geom_point for rankings in each category
  filtered_data <- kmeans_centers %>%
    group_by(feature) %>%
    mutate(rank = ifelse(as.character(feature) %in% c('PF_pg', 'PF_pp', 'TOV_pg', 'TOV_pp', 'TOV_pct_adv'), 
                         rank(center), 
                         rank(desc(center)))
    )%>% # adjust rank for high values in less desriable stat categories
    arrange(case_when(Cluster == cluster_value ~ 1, TRUE ~ 2), Cluster, rank, desc(center)) %>%
    mutate(Cluster = as.character(Cluster)) %>%
    filter(Cluster == cluster_value)
  
  plot <- kmeans_centers %>%
    group_by(feature) %>%
    mutate(rank = ifelse(as.character(feature) %in% c('PF_pg', 'PF_pp', 'TOV_pg', 'TOV_pp', 'TOV_pct_adv'), 
                         rank(center), 
                         rank(desc(center)))
    )%>% # adjust rank for high values in less desriable stat categories
    arrange(case_when(Cluster == cluster_value ~ 1, TRUE ~ 2), Cluster, rank, desc(center)) %>%
    ggplot(aes(x = factor(feature, levels = unique(feature)), y = center, color = cluster_value)) +
    geom_point(color = "#5A2D81") +
    geom_text(data = filtered_data, aes(label = rank), color = "black", vjust = -0.5) +  # Add point labels for rank
    theme_minimal() +
    gghighlight(Cluster == cluster_value, use_direct_label = FALSE) +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 90, size = 9, hjust = 0.5),
          axis.title = element_text(hjust = 0.5),
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
    labs(x = "Statistic", y = "Cluster Center",
         title = "Visualizing K-Means Cluster Makeups",
         subtitle = cluster_value)
  
  print(plot)
  
  
  # Bar Plot for Percentage of Stat Categories in Each Rank
  filtered_data <- kmeans_centers %>%
    group_by(feature) %>%
    mutate(rank = ifelse(as.character(feature) %in% c('PF_pg', 'PF_pp', 'TOV_pg', 'TOV_pp', 'TOV_pct_adv'), 
                         rank(center), 
                         rank(desc(center)))
    ) %>%
    arrange(case_when(Cluster == cluster_value ~ 1, TRUE ~ 2), Cluster, rank, desc(center)) %>%
    mutate(Cluster = as.character(Cluster)) %>%
    filter(Cluster == cluster_value)
  
  plot <- kmeans_centers %>%
    group_by(feature) %>%
    mutate(rank = ifelse(as.character(feature) %in% c('PF_pg', 'PF_pp', 'TOV_pg', 'TOV_pp', 'TOV_pct_adv'), 
                         rank(center), 
                         rank(desc(center)))
    ) %>%
    ungroup() %>%
    select(Cluster, rank) %>%
    group_by(Cluster, rank) %>%
    summarise(count = n()) %>%
    ungroup() %>%
    group_by(Cluster) %>%
    mutate(percentage = count / sum(count) * 100) %>%
    filter(Cluster == cluster_value) %>%
    ggplot(aes(x = as.factor(rank), y = percentage, fill = as.factor(rank))) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = paste0(round(percentage, 0), "%")), vjust = -0.5, color = "black") +
    labs(x = "Rank", y = "Percentage",
         title = "Percentage of Stat Categories in Each Rank", subtitle = cluster_value) +
    scale_fill_discrete(name = "Rank") +
    scale_x_discrete(limits = as.character(1:7)) +
    theme_minimal()
  
  print(plot)
  
  #Bar plot that shows count of traditional positions in each cluster
  df_2022 <- final_df %>%
    filter(Year %in% '2022')
  
  count_df <- df_2022 %>%
    filter(Cluster == substr(cluster_value, nchar(cluster_value), nchar(cluster_value))) %>%
    group_by(Pos) %>%
    summarise(count = n()) %>%
    ungroup() %>%
    arrange(desc(count))
  
  plot <- ggplot(count_df, aes(x = reorder(Pos, -count), y = count, fill = Pos)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = count), vjust = -0.5, color = "black") +
    scale_fill_manual(values = c("red", "blue", "green", "yellow", "orange")) +
    labs(x = "Pos", y = "Count", title = paste0("Bar Plot of Traditional Positions in ", cluster_value))
  
  print(plot)
}
```

```{r}
cluster_plots('Cluster 1')
```




```{r include = FALSE}
df_2022 <- df_2022 %>%
  mutate(Tm =ifelse(Player =='Aaron Holiday', gsub('TOT','PHO',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Andre Drummond', gsub('TOT','BRK',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Armoni Brooks', gsub('TOT','TOR',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Brad Wanamaker', gsub('TOT','WAS',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Bryn Forbes', gsub('TOT','DEN',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Buddy Hield', gsub('TOT','IND',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Cam Reddish', gsub('TOT','NYK',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Caris LeVert', gsub('TOT','CLE',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='CJ McCollum', gsub('TOT','NOP',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='DJ Augustin', gsub('TOT','LAL',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Daniel Theis', gsub('TOT','BOS',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Danuel House Jr', gsub('TOT','UTA',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Davis Bertans', gsub('TOT','DAL',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='DeAndre Bembry', gsub('TOT','MIL',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='DeAndre Jordan', gsub('TOT','PHI',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='DeMarcus Cousins', gsub('TOT','DEN',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Dennis Schroder', gsub('TOT','HOU',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Derrick White', gsub('TOT','BOS',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Domantas Sabonis', gsub('TOT','SAC',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Donte DiVincenzo', gsub('TOT','SAC',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Drew Eubanks', gsub('TOT','POR',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Elijah Hughes', gsub('TOT','POR',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Goran Dragic', gsub('TOT','BRK',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Isaiah Thomas', gsub('TOT','CHO',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Ish Smith', gsub('TOT','WAS',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Jalen Smith', gsub('TOT','IND',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='James Harden', gsub('TOT','PHI',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Javonte Smart', gsub('TOT','MIA',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Jeremy Lamb', gsub('TOT','SAC',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Jevon Carter', gsub('TOT','MIL',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Josh Hart', gsub('TOT','POR',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Josh Jackson', gsub('TOT','SAC',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Josh Richardson', gsub('TOT','SAS',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Juancho Hernangomez', gsub('TOT','UTA',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Justin Holiday', gsub('TOT','SAC',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Justin Robinson', gsub('TOT','DET',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Justise Winslow', gsub('TOT','POR',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Kelan Martin', gsub('TOT','BOS',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Keon Johnson', gsub('TOT','POR',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Kristaps Porzingis', gsub('TOT','WAS',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Lance Stephenson', gsub('TOT','IND',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Larry Nance Jr', gsub('TOT','NOP',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Malcolm Hill', gsub('TOT','CHI',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Marvin Bagley III', gsub('TOT','DET',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Montrezl Harrell', gsub('TOT','CHO',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Mychal Mulder', gsub('TOT','MIA',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Nickeil AlexanderWalker', gsub('TOT','UTA',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Norman Powell', gsub('TOT','LAC',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Paul Millsap', gsub('TOT','PHI',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Rajon Rondo', gsub('TOT','CLE',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Robert Covington', gsub('TOT','LAC',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Rodney Hood', gsub('TOT','LAC',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Romeo Langford', gsub('TOT','SAS',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Semi Ojeleye', gsub('TOT','LAC',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Serge Ibaka', gsub('TOT','MIL',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Seth Curry', gsub('TOT','BRK',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Spencer Dinwiddie', gsub('TOT','DAL',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Thaddeus Young', gsub('TOT','TOR',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Tomas Satoransky', gsub('TOT','WAS',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Tony Snell', gsub('TOT','NOP',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Torrey Craig', gsub('TOT','PHO',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Trey Lyles', gsub('TOT','SAC',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Tristan Thompson', gsub('TOT','CHI',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Tyrese Haliburton', gsub('TOT','IND',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Wenyen Gabriel', gsub('TOT','LAL',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Braxton Key', gsub('TOT','DET',Tm),Tm)) %>%
  mutate(Tm =ifelse(Player =='Braxton Key', gsub('TOT','DET',Tm),Tm)) %>%
```


```{r fig.width = 14}
#teams by cluster
ggplot(df_2022 %>% 
         mutate(Year = as.numeric(Year),
                Cluster = as.numeric(Cluster)) %>%
         filter(Year == 2022),
       aes(x = Tm, fill = factor(Cluster))) +
  geom_bar(position = "fill") + ylab("proportion") +
  stat_count(geom = "text", 
             aes(label = stat(count)),
             position=position_fill(vjust=0.5), colour="white") +
    scale_fill_discrete(name = "Player\nType", labels =c('Rebound\nKings', '3-point\nThreats', 'Game\nLieutenants', 'Bigmen\nShooters','Bench\nSupport', 'Primetime\nBigs', 'Superstars')) +
  theme(legend.key.height=unit(1, "cm"))
```
```{r}
df_2022 %>% filter(Tm == 'TOT')
```

