---
title: "NBA Clustering Project - Tidymodels"
author: "Mike Kaminski"
date: "2023-06-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE,
                      message = FALSE, dpi = 180,
                      fig.width = 10, fig.height = 5)
```


# Import Data

## Per 100 Possessions
```{r}
per_poss <- as.data.frame(read_csv("Data/per_poss.csv"))

per_poss1 <- per_poss %>%
  select('Year', everything(),-contains("Unnamed")) %>%
  rename_all(~ str_replace_all(., " ", "_")) %>%
  rename_all(~ str_replace_all(., "3", "Thr")) %>%
  rename_all(~ str_replace_all(., "2", "Two")) 
head(per_poss1)

```

## Advanced Stats
```{r}
adv <- as.data.frame(read_csv("Data/advanced.csv"))

adv1 <- adv %>%
  select('Year', everything(),-contains("Unnamed")) %>%
  rename_all(~ str_replace_all(., "%", "_PCT")) %>%
  rename_all(~ str_replace_all(., " ", "_")) %>%
  rename_all(~ str_replace_all(., "3", "Thr")) %>%
  rename_all(~ str_replace_all(., "2", "Two")) 
head(adv1)

```

## Shooting Stats
```{r}
shoot <- as.data.frame(read_csv("Data/shooting.csv"))

shoot1 <- shoot %>%
  select('Year', everything(),-contains("Unnamed")) %>%
  rename_all(~ str_replace_all(., " ", "_")) %>%
  rename(Avg_Dist_FGA = Dist.) %>%
  rename_all(~ str_replace_all(., "-", "_")) %>%
  rename_all(~ str_replace_all(., "_of", "")) %>%
  rename_all(~ str_replace_all(., "_by", "")) %>%
  rename_all(~ str_replace_all(., "Distance", "Dis"))
head(shoot1)
```

## Per Game
```{r}
per_game <- as.data.frame(read_csv("Data/per_game.csv"))

per_game1 <- per_game %>%
  select('Year', everything(),-contains("Unnamed")) %>%
  rename_all(~ str_replace_all(., "%", "_PCT")) %>%
  rename_all(~ str_replace_all(., "3", "Thr")) %>%
  rename_all(~ str_replace_all(., "2", "Two")) 
head(per_game1)
```

# Exploratory Data Analysis

## More Cleaning
There's a fair amount players that we need to remove from teh dataset given their lack of contribution to the team (Ex. playing only a few games or not playing a lot of minutes).

The data includes a team name called 'TOT' which indicates that a player played or more than one team.  These players' stats appear on multiple lines - one for each team and one for the Total that season.  We need to remove the underlying teams for each player with 'TOT' as their team so we're left with only one row for each player for each season they played.  We'll create a unique index (since the index wasn't included on the scrape) based on rank (which is essentially an index value based on player name), player name and year.  We'll arrange by Games (TOT will always be the highest) and remove duplicate instances for each dataframe

### Per 100 Possessions
```{r}
per_poss2 <- per_poss1 %>%
  mutate(player_year = paste0(Rk,Player,Year)) %>% # creates an ID
  mutate(player_year = str_replace_all(player_year," ","")) #removes spaces

per_poss3 <- per_poss2 %>% 
  arrange(Year, Player, desc(G))%>%
  filter(duplicated(player_year) == FALSE)

# compares the old df to the new df based on Team equaling 'TOT'. The TRUE valued should remain the same, the FALSE value should change because we're removing duplicates
per_poss2 %>% count(Tm == 'TOT')
per_poss3 %>% count(Tm == 'TOT')

```

### Advanced
```{r}
adv2 <- adv1 %>%
  mutate(player_year = paste0(Rk,Player,Year)) %>% # creates an ID
  mutate(player_year = str_replace_all(player_year," ","")) #removes spaces

adv3 <- adv2 %>% 
  arrange(Year, Player, desc(G))%>%
  filter(duplicated(player_year) == FALSE)

# compares the old df to the new df based on Team equaling 'TOT'. The TRUE valued should remain the same, the FALSE value should change because we're removing duplicates
adv2 %>% count(Tm == 'TOT')
adv3 %>% count(Tm == 'TOT')
```

### Shooting
```{r}
shoot2 <- shoot1 %>%
  mutate(player_year = paste0(Rk,Player,Year)) %>% # creates an ID
  mutate(player_year = str_replace_all(player_year," ","")) #removes spaces

shoot3 <- shoot2 %>% 
  arrange(Year, Player, desc(G))%>%
  filter(duplicated(player_year) == FALSE)

# compares the old df to the new df based on Team equaling 'TOT'. The TRUE valued should remain the same, the FALSE value should change because we're removing duplicates
shoot2 %>% count(Tm == 'TOT')
shoot3 %>% count(Tm == 'TOT')
```

### Per Game
```{r}
per_game2 <- per_game1 %>%
  mutate(player_year = paste0(Rk,Player,Year)) %>% # creates an ID
  mutate(player_year = str_replace_all(player_year," ","")) #removes spaces

per_game3 <- per_game2 %>% 
  arrange(Year, Player, desc(G))%>%
  filter(duplicated(player_year) == FALSE)

# compares the old df to the new df based on Team equaling 'TOT'. The TRUE valued should remain the same, the FALSE value should change because we're removing duplicates
per_game2 %>% count(Tm == 'TOT')
per_game3 %>% count(Tm == 'TOT')
```





Data was taken from the previous doc
```{r}
library(readr)
NBACleanData <- read_csv("Data/NBACleanData.csv",show_col_types = FALSE)
  
```


```{r}
nba <- NBACleanData %>%
  select(-c(1:10,"HOF","PF_pg","PF_pp","Heave_Att_sho","Heaves_Comp_sho","Dunks_PCT_FGA_sho","Dunks_sho")) #remove unwanted variables
# colnames(nba)

nba_2022 <- NBACleanData %>%
  filter(Year == 2022) %>%
  select(-c(1:10,"HOF","PF_pg","PF_pp","Heave_Att_sho","Heaves_Comp_sho","Dunks_PCT_FGA_sho","Dunks_sho")) #remove unwanted variables
  

```


```{r}
# trial for removing variables are seem to be duplicative
nba <- NBACleanData %>%
  select(-c(1:10,"HOF","PF_pg","PF_pp","Heave_Att_sho","Heaves_Comp_sho","Dunks_PCT_FGA_sho","Dunks_sho")) %>% #remove unwanted variables 
  select(
    -FG_pp, #field goals made per 100 possessions
    -ThrP_pp, # three pointers made
    -TwoP_pp, # two pointers made
    -FT_pp, # free throws made
    -contains("_pg"), # removes per game
    -contains("FG_PCT"),
    -Avg_Dist_FGA_sho,
    -contains("Corner"),
    -contains("PCT_FG_Ast"),
    -TRB_pp
  ) 

```

```{r}
normalize <- function(x)
{
  return((x- min(x)) /(max(x)-min(x)))
}
nba_normal <- as.data.frame(lapply(nba, FUN=normalize))
# nba_normal_2022 <- as.data.frame(lapply(nba_2022, FUN=normalize))
```



```{r}
library(tidymodels)

set.seed(525)

kclust <- kmeans(nba_normal, centers = 4)

# kclust_2022 <- kmeans(nba_normal_2022, centers = 7)

```

```{r}
library(broom)
tidy(kclust)
# tidy(kclust_2022)
```


```{r}
augment(kclust, nba_normal) %>%
  ggplot(aes(FGA_pp, TwoPA_pp, color = .cluster)) +
  geom_point()

# augment(kclust_2022, nba_normal_2022) %>%
#   ggplot(aes(PTS_pg, VORP_adv, color = .cluster)) +
#   geom_point()
```


```{r}
augment(kclust, nba_normal)
tidy(kclust)
glance(kclust)


# augment(kclust_2022, nba_normal_2022)
# tidy(kclust_2022)
# glance(kclust_2022)
```

```{r}
kclusts <- 
  tibble(k = 1:15) %>%
  mutate(
    kclust = map(k, ~ kmeans(nba_normal, .x)),
    tidied = map(kclust, tidy),
    glanced = map(kclust, glance),
    augmented = map(kclust, augment, nba_normal)
  )

kclusts

# kclusts_2022 <- 
#   tibble(k = 1:15) %>%
#   mutate(
#     kclust_2022 = map(k, ~ kmeans(nba_normal_2022, .x)),
#     tidied = map(kclust_2022, tidy),
#     glanced = map(kclust_2022, glance),
#     augmented = map(kclust_2022, augment, nba_normal_2022)
#   )
# 
# kclusts_2022
```


```{r}
kclusts %>%
  unnest(glanced) %>%
  ggplot(aes(k, tot.withinss)) +
  geom_line(alpha = 0.8) +
  geom_point(size = 2)

kclusts %>%
  unnest(glanced) %>%
  ggplot(aes(k, tot.withinss-lead(tot.withinss))) +
  geom_line(alpha = 0.8) +
  geom_point(size = 2)

kclusts %>%
  unnest(glanced) %>%
  ggplot(aes(k, tot.withinss-lead(tot.withinss,n=2))) +
  geom_line(alpha = 0.8) +
  geom_point(size = 2)


kclusts %>%
  unnest(glanced) %>%
  ggplot(aes(k, tot.withinss)) +
  geom_line(alpha = 0.8) +
  geom_point(size = 2) +

  geom_line(aes(k, tot.withinss-lead(tot.withinss)), alpha = 0.8 ) +
  geom_point(aes(k, tot.withinss-lead(tot.withinss)),size = 2,color = "red") +

  geom_line(aes(k, tot.withinss-lead(tot.withinss,n=2)), alpha = 0.8) +
  geom_point(aes(k, tot.withinss-lead(tot.withinss,n=2)),size = 2, color = "blue")
```



```{r}
clusters <- 
  kclusts %>%
  unnest(cols = c(tidied))

assignments <- 
  kclusts %>% 
  unnest(cols = c(augmented))

clusterings <- 
  kclusts %>%
  unnest(cols = c(glanced))

clusters_2022 <- 
  kclusts_2022 %>%
  unnest(cols = c(tidied))

assignments_2022 <- 
  kclusts_2022 %>% 
  unnest(cols = c(augmented))

clusterings_2022 <- 
  kclusts_2022 %>%
  unnest(cols = c(glanced))


```

```{r}
p1 <- 
  ggplot(assignments,aes(x=FG_pp, y = FGA_pp)) +
  geom_point(aes(color = .cluster), alpha = 0.8) + 
  facet_wrap(~ k)
p1
```

# hierarchical
```{r}
library(workflows)
library(parsnip)
library(tidyclust)
library(tidyverse)
```

```{r}

```

